int red = 5;
int yellow = 3;
int green = 2;
int pedstart = 9;
int pedstop = 11;
int beeper = 13;
int button = 7;

const unsigned long SLICE_MS = 125;
const unsigned long YELLOW_MS = 3000;
const unsigned long WALK_MS = 4000;

void setup() {
	pinMode(red, OUTPUT);
	pinMode(yellow, OUTPUT);
	pinMode(green, OUTPUT);
	pinMode(pedstart, OUTPUT);
	pinMode(pedstop, OUTPUT);
	pinMode(beeper, OUTPUT);
	pinMode(button, INPUT_PULLUP);
}

void forcered() {
  // YELLOW PHASE - warn drivers before red
  digitalWrite(green, LOW);
  digitalWrite(yellow, HIGH);
  digitalWrite(red, LOW);
  noTone(beeper);

  // Edge detection: track button state to detect press moment (HIGH->LOW)
  int prev = digitalRead(button);
  unsigned long t0 = millis();

  // Stay yellow for YELLOW_MS, but restart timer if button pressed again
  while (millis() - t0 < YELLOW_MS) {
    int now = digitalRead(button);
    bool pressedEdge = (prev == HIGH && now == LOW);
    prev = now; // CRITICAL: update prev so we can detect next press

    if (pressedEdge) {
      t0 = millis(); // restart yellow timer
    }
    delay(SLICE_MS);
  }

  // WALK PHASE - red light with walk signal
  digitalWrite(red, HIGH);
  digitalWrite(yellow, LOW);
  digitalWrite(green, LOW);
  digitalWrite(pedstart, HIGH);
  digitalWrite(pedstop, LOW);
  noTone(beeper);

  // Wait for full walk time (pedestrian safety)
  t0 = millis();
  while (millis() - t0 < WALK_MS) {
    delay(SLICE_MS);
  }

  // BLINK WARNING PHASE - warn pedestrians crossing time is ending
  digitalWrite(red, HIGH);
  digitalWrite(pedstart, LOW);
  digitalWrite(yellow, LOW);
  digitalWrite(green, LOW);

  // Blink DON'T WALK 4 times before returning to normal cycle
  for (int i = 0; i < 4; i++) {
    digitalWrite(pedstop, HIGH);
    delay(500); // Use simple delay here - pedestrian safety requires blink to complete
    digitalWrite(pedstop, LOW);
    delay(500);
  }
}

bool wait_sliced_interruptible(unsigned long ms) {
  // Wait for specified time while checking button every SLICE_MS
  unsigned long t0 = millis();
  while (millis() - t0 < ms) {
    if (digitalRead(button) == LOW) {
      forcered(); // button pressed, interrupt the wait
      return true;
    }
    delay(SLICE_MS);
  }
  return false; // timeout, no button press
}

bool beep_sliced_interruptible(unsigned long onMs, unsigned long offMs, unsigned int freq) {
  // Make beep pattern (on/off) while checking button
  tone(beeper, freq);
  if (wait_sliced_interruptible(onMs)) {
    noTone(beeper);
    return true; // button pressed during beep
  }
  noTone(beeper);
  if (wait_sliced_interruptible(offMs)) {
    return true; // button pressed during silence
  }
  return false; // beep pattern completed
}

void loop() {
  // Check button at start of cycle
  if (digitalRead(button) == LOW) {
    forcered();
    return; // restart cycle after forcered() completes
  }

  // GREEN PHASE - cars go, pedestrians wait
  digitalWrite(red, LOW);
  digitalWrite(yellow, LOW);
  digitalWrite(green, HIGH);
  digitalWrite(pedstart, LOW);
  digitalWrite(pedstop, HIGH);

  // 8 beeps = 8 seconds of green
  for (int i = 0; i < 8; i++) {
    if (beep_sliced_interruptible(500, 500, 2500)) return;
  }

  if (digitalRead(button) == LOW) {
    forcered();
    return;
  }

  // YELLOW PHASE - transition warning
  digitalWrite(red, LOW);
  digitalWrite(yellow, HIGH);
  digitalWrite(green, LOW);
  digitalWrite(pedstart, LOW);
  digitalWrite(pedstop, HIGH);

  // 3 beeps = 3 seconds of yellow
  for (int i = 0; i < 3; i++) {
    if (beep_sliced_interruptible(500, 500, 2500)) return;
  }

  if (digitalRead(button) == LOW) {
    forcered();
    return;
  }

  // RED PHASE - cars stop, pedestrians walk
  digitalWrite(red, HIGH);
  digitalWrite(pedstart, HIGH);
  digitalWrite(yellow, LOW);
  digitalWrite(green, LOW);
  digitalWrite(pedstop, LOW);

  if (wait_sliced_interruptible(4000)) return; // 4 seconds walk time

  if (digitalRead(button) == LOW) {
    forcered();
    return;
  }

  // RED PHASE CONTINUES - blink DON'T WALK warning
  digitalWrite(red, HIGH);
  digitalWrite(pedstart, LOW);
  digitalWrite(yellow, LOW);
  digitalWrite(green, LOW);

  // Blink 4 times to warn crossing time is over
  for (int i = 0; i < 4; i++) {
    digitalWrite(pedstop, HIGH);
    if (wait_sliced_interruptible(500)) return;
    digitalWrite(pedstop, LOW);
    if (wait_sliced_interruptible(500)) return;
  }

  // Loop restarts automatically - back to green
}
